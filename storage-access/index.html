<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Storage Access API — Embedded Tester (Site B)</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; line-height: 1.45; margin: 0; padding: 18px; }
    h1 { margin: 0 0 10px 0; }
    p { margin: 8px 0; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .card { border: 1px solid rgba(127,127,127,0.28); border-radius: 14px; padding: 12px; margin: 12px 0; background: rgba(127,127,127,0.06); }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid rgba(127,127,127,0.35);
      background: rgba(127,127,127,0.12);
      color: inherit;
      cursor: pointer;
    }
    button:hover { background: rgba(127,127,127,0.18); }
    pre { padding: 12px; border-radius: 10px; overflow: auto; background: rgba(127,127,127,0.14); margin: 0; }
    .ok { border-color: rgba(0,160,0,0.6); }
    .no { border-color: rgba(200,0,0,0.6); }
  </style>
</head>
<body>
  <h1 id="title">Site B</h1>

  <div class="card" id="mode"></div>

  <div class="card" id="actionCard" style="display:none;">
    <p><b>One click to run everything:</b></p>
    <button id="run">Run full test (includes requestStorageAccess)</button>
    <p><small>
      This click is required for user activation. The page will log before/after and post results to Site A.
    </small></p>
  </div>

  <div class="card">
    <pre id="out"></pre>
  </div>

  <script>
    const ORIGIN_A = "https://test-website-a.pages.dev";

    const outEl = document.getElementById("out");
    const modeEl = document.getElementById("mode");
    const actionCard = document.getElementById("actionCard");

    function line(s) {
      outEl.textContent += s + "\n";
      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: "line", line: s }, ORIGIN_A);
        }
      } catch {}
    }

    function cookieMap() {
      const out = {};
      const raw = document.cookie || "";
      raw.split(";").map(s => s.trim()).filter(Boolean).forEach(pair => {
        const i = pair.indexOf("=");
        const k = i >= 0 ? pair.slice(0, i) : pair;
        const v = i >= 0 ? pair.slice(i + 1) : "";
        out[decodeURIComponent(k)] = decodeURIComponent(v);
      });
      return out;
    }

    function setCookie(name, value) {
      // Eligible for 3P contexts when allowed.
      document.cookie = encodeURIComponent(name) + "=" + encodeURIComponent(value) + "; Path=/; Max-Age=31536000; SameSite=None; Secure";
    }

    function randHex(nBytes) {
      try {
        const a = new Uint8Array(nBytes);
        crypto.getRandomValues(a);
        return Array.from(a).map(x => x.toString(16).padStart(2, "0")).join("");
      } catch {
        return Math.random().toString(16).slice(2) + Math.random().toString(16).slice(2);
      }
    }

    function lsGet(k) {
      try { return { ok: true, v: localStorage.getItem(k) }; }
      catch (e) { return { ok: false, err: (e && e.name ? e.name : "Error") + ": " + (e && e.message ? e.message : String(e)) }; }
    }

    function lsSet(k, v) {
      try { localStorage.setItem(k, v); return { ok: true }; }
      catch (e) { return { ok: false, err: (e && e.name ? e.name : "Error") + ": " + (e && e.message ? e.message : String(e)) }; }
    }

    async function hasStorageAccess() {
      if (typeof document.hasStorageAccess !== "function") return { supported: false, value: null, error: null };
      try { return { supported: true, value: await document.hasStorageAccess(), error: null }; }
      catch (e) { return { supported: true, value: null, error: (e && e.name ? e.name : "Error") + ": " + (e && e.message ? e.message : String(e)) }; }
    }

    async function hasUnpartitionedCookieAccess() {
      if (typeof document.hasUnpartitionedCookieAccess !== "function") return { supported: false, value: null, error: null };
      try { return { supported: true, value: await document.hasUnpartitionedCookieAccess(), error: null }; }
      catch (e) { return { supported: true, value: null, error: (e && e.name ? e.name : "Error") + ": " + (e && e.message ? e.message : String(e)) }; }
    }

    function dumpObj(o) { return JSON.stringify(o, null, 2); }

    async function snapshot(label) {
      const supported = {
        hasStorageAccess: typeof document.hasStorageAccess === "function",
        requestStorageAccess: typeof document.requestStorageAccess === "function",
        hasUnpartitionedCookieAccess: typeof document.hasUnpartitionedCookieAccess === "function",
      };

      const hsa = await hasStorageAccess();
      const huca = await hasUnpartitionedCookieAccess();
      const cookies = cookieMap();

      const fpCookie = cookies["saa_fp_cookie"] || "";
      const fpToken = lsGet("saa_fp_token");

      return {
        label,
        supported,
        hasStorageAccess: hsa,
        hasUnpartitionedCookieAccess: huca,
        fpCookieVisible: Boolean(fpCookie),
        fpLocalStorageVisible: fpToken.ok && Boolean(fpToken.v),
        fpCookieValue: fpCookie,
        fpLocalStorageValue: fpToken.ok ? fpToken.v : null,
        fpLocalStorageError: fpToken.ok ? null : fpToken.err,
        rawCookie: document.cookie || ""
      };
    }

    async function runFullTest() {
      outEl.textContent = "";

      line("[" + new Date().toISOString() + "] starting test");

      const before = await snapshot("before");
      line(dumpObj(before));

      let req = { attempted: false, ok: null, error: null };
      if (typeof document.requestStorageAccess !== "function") {
        req = { attempted: false, ok: null, error: "requestStorageAccess not supported" };
      } else {
        req.attempted = true;
        try {
          line("Calling document.requestStorageAccess()...");
          await document.requestStorageAccess();
          req.ok = true;
          line("✅ requestStorageAccess resolved");
        } catch (e) {
          req.ok = false;
          req.error = (e && e.name ? e.name : "Error") + ": " + (e && e.message ? e.message : String(e));
          line("❌ requestStorageAccess rejected: " + req.error);
        }
      }

      const after = await snapshot("after");
      line(dumpObj(after));

      const actuallyWorks =
        // strongest signals in a static page:
        // “first-party seeded” state becomes visible in the embedded context after the request.
        (!before.fpCookieVisible && after.fpCookieVisible) ||
        (!before.fpLocalStorageVisible && after.fpLocalStorageVisible);

      const summary = {
        requestStorageAccess: req,
        before: {
          fpCookieVisible: before.fpCookieVisible,
          fpLocalStorageVisible: before.fpLocalStorageVisible,
          hasStorageAccess: before.hasStorageAccess
        },
        after: {
          fpCookieVisible: after.fpCookieVisible,
          fpLocalStorageVisible: after.fpLocalStorageVisible,
          hasStorageAccess: after.hasStorageAccess
        },
        actuallyWorks
      };

      try {
        if (window.parent && window.parent !== window) {
          window.parent.postMessage({ type: "summary", summary }, ORIGIN_A);
        }
      } catch {}

      const badge = document.createElement("div");
      badge.className = "card " + (actuallyWorks ? "ok" : "no");
      badge.innerHTML = actuallyWorks
        ? "<b>PASS:</b> Embedded context gained visibility into first-party-seeded state after the request."
        : "<b>NO CLEAR PASS:</b> No change detected. This can mean SAA is unsupported, the request was denied, or your sites aren’t truly cross-site in this environment.";
      document.body.insertBefore(badge, document.body.children[2]);
    }

    // Mode routing.
    const inIframe = window.top !== window.self;
    const params = new URLSearchParams(location.search);
    const wantsEmbed = params.get("embed") === "1";

    if (!inIframe && params.get("seed") === "1") {
      // Auto-seed in top-level with zero clicks.
      const token = randHex(16);
      const t = new Date().toISOString();

      const ls1 = lsSet("saa_fp_token", token);
      setCookie("saa_fp_cookie", token);
      lsSet("saa_fp_seed_time", t);
      setCookie("saa_fp_seed_time", t);

      document.getElementById("title").textContent = "Site B — Seeded";
      modeEl.className = "card ok";
      modeEl.innerHTML = [
        "<b>Seed complete.</b>",
        "<div>Token: <span class='mono'>" + token + "</span></div>",
        "<div>Time: <span class='mono'>" + t + "</span></div>",
        "<div><small>Now return to the Site A tab and click “Run full test” inside the iframe.</small></div>",
        (!ls1.ok ? "<div><small>localStorage write error: <span class='mono'>" + ls1.err + "</span></small></div>" : "")
      ].join("");

      line("Seeded first-party state on B.");
      line("document.cookie=" + (document.cookie || ""));
      const seedTime = lsGet("saa_fp_seed_time");
      line("localStorage.saa_fp_seed_time=" + (seedTime.ok ? seedTime.v : seedTime.err));
    } else if (inIframe || wantsEmbed) {
      document.getElementById("title").textContent = "Site B — Embedded tester";
      modeEl.className = "card";
      modeEl.innerHTML = [
        "<div>Running embedded in iframe: <span class='mono'>" + String(inIframe) + "</span></div>",
        "<div>Origin: <span class='mono'>" + location.origin + "</span></div>",
        "<div><small>Click once to run availability + request + verification.</small></div>"
      ].join("");
      actionCard.style.display = "block";

      document.getElementById("run").addEventListener("click", runFullTest);
      line("Ready. Click “Run full test”.");
    } else {
      // Friendly default if someone visits B without ?seed=1.
      document.getElementById("title").textContent = "Site B — Setup";
      modeEl.className = "card";
      modeEl.innerHTML = [
        "<b>Open this page with <span class='mono'>?seed=1</span> to auto-seed first-party state.</b>",
        "<div><small>Usually you’ll open it via the button on Site A.</small></div>"
      ].join("");
      line("Visit /?seed=1 to seed first-party state.");
    }
  </script>
</body>
</html>

